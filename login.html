<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø±ÙÙŠÙ‚</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary-color: #3498db;
        --primary-dark: #2980b9;
        --secondary-color: #0ea5e9;
        --accent-color: #6366f1;
        --success-color: #10b981;
        --error-color: #ef4444;
        --text-color: #1e293b;
        --text-light: #64748b;
        --bg-color: #f8fafc;
        --card-bg: #ffffff;
        --card-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        --gradient: linear-gradient(
          135deg,
          var(--primary-color),
          var(--accent-color)
        );
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        transition: all 0.3s ease;
      }

      body {
        font-family: "Cairo", sans-serif;
        background-color: var(--bg-color);
        background-image: radial-gradient(#e0f2fe 1px, transparent 1px),
          radial-gradient(#e0f2fe 1px, transparent 1px);
        background-size: 40px 40px;
        background-position: 0 0, 20px 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }

      .container {
        width: 100%;
        max-width: 450px;
        background: var(--card-bg);
        border-radius: 24px;
        box-shadow: var(--card-shadow);
        padding: 40px;
        position: relative;
        overflow: hidden;
        transform: translateY(20px);
        opacity: 0;
        animation: fadeIn 0.6s forwards;
      }

      @keyframes fadeIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .logo-container {
        text-align: center;
        margin-bottom: 30px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .logo {
        width: 80px;
        height: 80px;
        background: var(--card-bg);
        border-radius: 22px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        padding: 12px;
        margin-bottom: 16px;
        animation: float 3s ease-in-out infinite;
      }

      @keyframes float {
        0% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      h1 {
        color: var(--text-color);
        font-size: 2.2rem;
        margin-bottom: 5px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      p.subtitle {
        color: var(--text-light);
        margin-bottom: 40px;
        font-weight: 300;
        font-size: 1.1rem;
      }

      .form-group {
        margin-bottom: 24px;
        position: relative;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-color);
        font-weight: 600;
        font-size: 0.95rem;
      }

      .input-container {
        position: relative;
      }

      input {
        width: 100%;
        padding: 16px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 1rem;
        font-family: "Cairo", sans-serif;
        color: var(--text-color);
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(4px);
      }

      input:focus {
        border-color: var(--primary-color);
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
      }

      .forgot-link {
        font-size: 0.9rem;
        display: block;
        margin-top: 10px;
        text-align: left;
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
      }

      .forgot-link:hover {
        color: var(--primary-dark);
        text-decoration: underline;
      }

      .btn {
        width: 100%;
        background: var(--gradient);
        color: white;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
        position: relative;
        overflow: hidden;
        font-family: "Cairo", sans-serif;
      }

      .btn::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          rgba(255, 255, 255, 0.2),
          rgba(255, 255, 255, 0)
        );
        transform: translateY(-50%);
        transition: transform 0.6s ease;
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
      }

      .btn:hover::after {
        transform: translateY(0);
      }

      .btn:active {
        transform: translateY(1px);
      }

      .footer-link {
        text-align: center;
        margin-top: 24px;
        color: var(--text-light);
        font-size: 0.95rem;
      }

      .footer-link a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 600;
      }

      .footer-link a:hover {
        color: var(--accent-color);
        text-decoration: underline;
      }

      .alert {
        padding: 16px;
        border-radius: 12px;
        margin-bottom: 24px;
        font-size: 0.95rem;
        text-align: center;
        opacity: 0;
        transform: translateY(-10px);
        animation: fadeIn 0.3s forwards;
      }

      .error-box {
        background-color: rgba(254, 226, 226, 0.7);
        color: var(--error-color);
        border-left: 4px solid var(--error-color);
      }

      .success-box {
        background-color: rgba(209, 250, 229, 0.7);
        color: var(--success-color);
        border-left: 4px solid var(--success-color);
      }

      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: var(--primary-color);
        border-radius: 50%;
        pointer-events: none;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(52, 152, 219, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(52, 152, 219, 0);
        }
      }

      .loader {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="logo-container">
        <div class="logo">
          <img src="icon.png" alt="Rafiq Logo" width="100%" />
        </div>
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="subtitle">Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ø¹ÙˆØ¯ØªÙƒ Ø¥Ù„Ù‰ Ø±ÙÙŠÙ‚</p>
      </div>

      <div id="errorBox" class="alert error-box" style="display: none"></div>

      <form id="loginForm">
        <div class="form-group">
          <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <div class="input-container">
            <input
              type="email"
              id="email"
              placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <div class="input-container">
            <input
              type="password"
              id="password"
              placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
              required
            />
          </div>
          <a href="forgot-password.html" class="forgot-link"
            >Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a
          >
        </div>

        <button type="submit" class="btn" id="submitBtn">
          <span id="btnText">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
          <span id="btnLoader" style="display: none">
            <div class="loader"></div>
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...
          </span>
        </button>
      </form>

      <div class="footer-link">
        Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="register.html">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
      </div>
    </div>

    <script>
      const form = document.getElementById("loginForm");
      const errorBox = document.getElementById("errorBox");
      const submitBtn = document.getElementById("submitBtn");
      const btnText = document.getElementById("btnText");
      const btnLoader = document.getElementById("btnLoader");

      // Floating animation on input focus
      const inputs = document.querySelectorAll("input");
      inputs.forEach((input) => {
        input.addEventListener("focus", function () {
          this.parentElement.style.transform = "translateY(-3px)";
          this.parentElement.style.boxShadow =
            "0 6px 15px rgba(52, 152, 219, 0.1)";
        });

        input.addEventListener("blur", function () {
          this.parentElement.style.transform = "translateY(0)";
          this.parentElement.style.boxShadow = "none";
        });
      });

      // Create confetti effect
      function createConfetti() {
        const confettiCount = 100;
        const container = document.querySelector("body");

        for (let i = 0; i < confettiCount; i++) {
          const confetti = document.createElement("div");
          confetti.className = "confetti";

          const colors = [
            "#3498db",
            "#10b981",
            "#f59e0b",
            "#6366f1",
            "#ef4444",
          ];
          confetti.style.backgroundColor =
            colors[Math.floor(Math.random() * colors.length)];

          confetti.style.left = Math.random() * 100 + "vw";
          confetti.style.top = -10 + "px";
          confetti.style.transform = `scale(${Math.random()})`;

          const size = Math.random() * 10 + 5;
          confetti.style.width = `${size}px`;
          confetti.style.height = `${size}px`;

          container.appendChild(confetti);

          // Animation
          const animation = confetti.animate(
            [
              {
                transform: `translate(0, 0) rotate(0deg)`,
                opacity: 1,
              },
              {
                transform: `translate(${Math.random() * 100 - 50}px, ${
                  Math.random() * 800 + 600
                }px) rotate(${Math.random() * 360}deg)`,
                opacity: 0,
              },
            ],
            {
              duration: Math.random() * 3000 + 2000,
              easing: "cubic-bezier(0.1, 0.9, 0.2, 1)",
            }
          );

          animation.onfinish = () => {
            confetti.remove();
          };
        }
      }

      function showError(message) {
        errorBox.textContent = message;
        errorBox.style.display = "block";
        errorBox.style.animation = "none";
        setTimeout(() => {
          errorBox.style.animation = "fadeIn 0.3s forwards";
        }, 10);
      }

      function resetSubmitButton() {
        btnText.style.display = "block";
        btnLoader.style.display = "none";
        submitBtn.disabled = false;
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        errorBox.style.display = "none";

        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!email || !password) {
          showError("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
          return;
        }

        // Animation for button loading state
        btnText.style.display = "none";
        btnLoader.style.display = "inline-flex";
        submitBtn.disabled = true;

        // Simulate a delay for demo purposes
        // Add this to the end of the script section in login.html
        // Replace the existing fetch call in the form submit event listener

        fetch("http://localhost:3001/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email, password }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.message === "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­") {
              // Store user data
              localStorage.setItem("user", JSON.stringify(data.user));

              // IMPORTANT: Store the token separately as well for direct access
              localStorage.setItem("token", data.token);
              localStorage.removeItem("guest");

              // Migrate guest journals to backend
              /// I will call the migration functions when I finish the backend :
              migrateGuestJournalsToBackend(data.token);
              migrateCommitmentToBackend(data.token);
              migrateGuestHabitsToBackend(data.token);
              // Show success animation and confetti
              createConfetti();

              // Create a success box
              const successBox = document.createElement("div");
              successBox.className = "alert success-box";
              successBox.textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±Ù ØªØ­ÙˆÙŠÙ„Ùƒ...";

              // Insert before the form
              form.parentNode.insertBefore(successBox, form);

              // Hide form
              form.style.display = "none";

              // Redirect after delay
              setTimeout(() => {
                window.location.href = "main.html"; // Ø£Ùˆ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
              }, 2000);
            } else {
              showError(data.message || "ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
              resetSubmitButton();
            }
          })
          .catch((err) => {
            console.error(err);
            showError("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.");
            resetSubmitButton();
          });
      });

      // Function to migrate local habits to backend :
      function migrateGuestHabitsToBackend(token) {
        const habits = JSON.parse(localStorage.getItem("habits")) || [];

        if (!habits.length) return;

        Promise.all(
          habits.map((habit) =>
            fetch("http://localhost:3001/habits", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                name: habit.name,
                description: habit.description,
                icon: habit.icon,
              }),
            })
          )
        )
          .then(() => {
            console.log("âœ… ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø¹Ø§Ø¯Ø§Øª Ø§Ù„Ø²Ø§Ø¦Ø± Ø¨Ù†Ø¬Ø§Ø­");

            const user = JSON.parse(localStorage.getItem("user"));
            const currentUserId = user?._id;

            // Ø£Ø¶Ù userId Ù„ÙƒÙ„ Ø¹Ø§Ø¯Ø© Ø²Ø§Ø¦Ø±
            const updatedHabits = habits.map((h) => ({
              ...h,
              userId: currentUserId,
            }));

            localStorage.setItem("habits", JSON.stringify(updatedHabits));
          })

          .catch((err) => {
            console.error("âŒ ÙØ´Ù„ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª:", err);
          });
      }

      // Function to migrate local commitments to backend :
      function migrateCommitmentToBackend(token) {
        const local = JSON.parse(localStorage.getItem("commitmentData"));
        if (!local) return;

        fetch("http://localhost:3001/commitment", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: "Bearer " + token,
          },
          body: JSON.stringify({
            negativeImpact: local.negativeImpact || "",
            recoveryBenefits: local.recoveryBenefits || "",
            motivationImage: local.motivationImage || null,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            console.log("âœ… Commitment migrated:", data);
            localStorage.removeItem("commitmentData"); // Ø­Ø°ÙÙ‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ø­ÙŠÙ„
          })
          .catch((err) => console.error("âŒ Error migrating commitment:", err));
      }

      // Function to migrate local journals to backend :
      function migrateGuestJournalsToBackend(token) {
        if (!token) {
          console.error("Token is missing. Cannot proceed.");
          return;
        }

        const user = JSON.parse(localStorage.getItem("user"));
        if (!user || !user._id) {
          console.error("User ID is missing. Cannot proceed.");
          return;
        }

        const currentUserId = user._id;

        const freeEntries = (
          JSON.parse(localStorage.getItem("free_entries")) || []
        ).filter((e) => !e.userId || e.userId === currentUserId);
        const relapseEntries = (
          JSON.parse(localStorage.getItem("relapse_entries")) || []
        ).filter((e) => !e.userId || e.userId === currentUserId);

        const allEntries = [
          ...freeEntries.map((e) => ({
            type: "free",
            title: e.title || "Ù…Ø°ÙƒØ±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†",
            text: e.text,
            date: e.date,
          })),
          ...relapseEntries.map((e) => ({
            type: "relapse",
            trigger: e.trigger,
            text: e.text,
            date: e.date,
          })),
        ];

        if (allEntries.length === 0) return;

        Promise.all(
          allEntries.map((entry) =>
            fetch("http://localhost:3001/journal", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(entry),
            })
          )
        )
          .then(() => {
            console.log("âœ… ØªÙ… ØªØ±Ø­ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");

            // Ø¥Ø¶Ø§ÙØ© userId Ù„Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø£Ø®Ø±Ù‰
            console.log("ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø§Ù„Ø²Ø§Ø¦Ø±)...");

            // Ø­Ø°Ù Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ userId (ÙƒØ§Ù†Øª Ù…Ø°ÙƒØ±Ø§Øª Ø²Ø§Ø¦Ø±)
            const cleanedFree = freeEntries.filter(
              (e) => e.userId === currentUserId
            );
            const cleanedRelapse = relapseEntries.filter(
              (e) => e.userId === currentUserId
            );

            localStorage.setItem("free_entries", JSON.stringify(cleanedFree));
            localStorage.setItem(
              "relapse_entries",
              JSON.stringify(cleanedRelapse)
            );
          })
          .catch((err) => {
            console.error("âŒ ÙØ´Ù„ ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª:", err);
          });
      }
    </script>
  </body>
</html>
